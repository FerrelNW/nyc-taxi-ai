{% extends "layout.html" %}

{% block title %}Destination Analysis - NYC Taxi AI{% endblock %}

{% block extra_css %}
<style>
    #map { 
        height: 500px; 
        width: 100%; 
        border-radius: 12px; 
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    
    .search-container { 
        position: relative; 
    }
    
    .search-results {
        position: absolute; 
        top: 100%; 
        left: 0; 
        right: 0;
        background: white; 
        border: 1px solid #e5e7eb;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px; 
        overflow-y: auto; 
        z-index: 1000;
        display: none; 
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    
    .search-item { 
        padding: 10px 12px; 
        cursor: pointer; 
        border-bottom: 1px solid #f3f4f6; 
        font-size: 14px; 
        transition: background-color 0.2s;
    }
    
    .search-item:hover { 
        background-color: #f0f9ff; 
        color: #0284c7; 
    }
    
    .cluster-circle {
        stroke-width: 2;
        stroke-dasharray: 5,5;
        animation: dash 30s linear infinite;
    }
    
    @keyframes dash {
        to { stroke-dashoffset: 1000; }
    }
    
    .prediction-card {
        border-left: 4px solid;
        transition: transform 0.3s;
    }
    
    .prediction-card:hover {
        transform: translateY(-5px);
    }
    
    .rank-badge {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 14px;
    }
    
    .cluster-area {
        fill-opacity: 0.1;
        stroke-width: 2;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">NYC Taxi Destination Prediction</h1>
        <p class="text-gray-600">Prediksi 3 zona tujuan teratas berdasarkan lokasi awal dan waktu</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Panel: Input -->
        <div class="lg:col-span-1">
            <div class="glass-card rounded-2xl p-6 shadow-lg border border-gray-100 h-full">
                <h2 class="text-xl font-bold text-gray-900 mb-6">Input Data</h2>

                <!-- Time Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-800 mb-2">
                        <i class="far fa-clock text-gray-600 mr-2"></i> Waktu
                    </label>
                    <div class="flex gap-2 mb-2">
                        <select id="hour" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                            {% for h in range(24) %}
                            <option value="{{ h }}" {% if h==now.hour %}selected{% endif %}>{{ "%02d"|format(h) }}:00</option>
                            {% endfor %}
                        </select>
                        <select id="day" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="0">Senin</option>
                            <option value="1">Selasa</option>
                            <option value="2">Rabu</option>
                            <option value="3">Kamis</option>
                            <option value="4">Jumat</option>
                            <option value="5">Sabtu</option>
                            <option value="6">Minggu</option>
                        </select>
                    </div>
                </div>

                <!-- Passengers -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-800 mb-2">
                        <i class="fas fa-users text-gray-600 mr-2"></i> Penumpang
                    </label>
                    <input type="number" id="passengers" min="1" max="6" value="1"
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                </div>

                <!-- Pickup Location -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-800 mb-2">
                        <i class="fas fa-map-pin text-green-500 mr-2"></i> Lokasi Awal
                    </label>
                    <div class="search-container">
                        <div class="relative">
                            <input type="text" id="pickup_input" 
                                   class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                   placeholder="Cari lokasi awal...">
                            <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                        </div>
                        <div id="pickup_results" class="search-results"></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Atau klik di peta</p>
                    <input type="hidden" id="pickup_lat">
                    <input type="hidden" id="pickup_lon">
                </div>

                <!-- Predict Button -->
                <button onclick="predictDestination()" id="predictBtn"
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3.5 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl flex items-center justify-center">
                    <i class="fas fa-bullseye mr-3 text-lg"></i>
                    <span class="text-base">Prediksi Tujuan</span>
                </button>

                <!-- Loading -->
                <div id="loading" class="hidden mt-6 text-center">
                    <div class="inline-flex items-center">
                        <div class="relative mr-3">
                            <div class="w-8 h-8 border-4 border-purple-200 rounded-full"></div>
                            <div class="absolute top-0 left-0 w-8 h-8 border-4 border-purple-600 rounded-full border-t-transparent animate-spin"></div>
                        </div>
                        <p class="text-gray-600">Menganalisis pola perjalanan...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Map and Results -->
        <div class="lg:col-span-2">
            <!-- Map -->
            <div class="glass-card rounded-2xl overflow-hidden shadow-lg border border-gray-100 mb-8">
                <div id="map" class="h-[400px]"></div>
                <div class="p-4 border-t border-gray-200 bg-gray-50">
                    <div class="flex flex-wrap gap-3 text-sm">
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                            <span class="text-gray-700">Lokasi Awal</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                            <span class="text-gray-700">Tujuan #1</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full bg-blue-500 mr-2"></div>
                            <span class="text-gray-700">Tujuan #2</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full bg-yellow-500 mr-2"></div>
                            <span class="text-gray-700">Tujuan #3</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div id="result_section" class="hidden">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Top 3 Prediksi Tujuan</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="top_predictions_grid">
                    <!-- Results will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize map
    const map = L.map('map').setView([40.7580, -73.9855], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    let pickupMarker = null;
    let clusterLayers = null;
    let predictionMarkers = [];
    let clusterAreas = [];

    // Load clusters from JSON
    const clusterData = {
        "pickup_clusters": [
            [40.712584223956, -73.99494070586509],      // Financial District
            [40.76458624494709, -73.87699052727912],    // Queens Central
            [40.79285681721363, -73.95391360756365],    // Upper Manhattan
            [40.76640560775985, -73.9715164651916],     // Midtown Manhattan
            [40.651514841924914, -73.78525769699498],   // Brooklyn Downtown
            [40.74585022332249, -73.98994659096626]     // JFK/Outer Boroughs
        ]
    };

    const clusterNames = [
        {name: "Financial District", color: "#3B82F6", type: "Business"},
        {name: "Queens Central", color: "#10B981", type: "Residential"},
        {name: "Upper Manhattan", color: "#8B5CF6", type: "Upscale"},
        {name: "Midtown Manhattan", color: "#EF4444", type: "Business/Tourism"},
        {name: "Brooklyn Downtown", color: "#F59E0B", type: "Commercial"},
        {name: "JFK/Outer Boroughs", color: "#EC4899", type: "Airport"}
    ];

    // Load clusters on map
    function loadClusters() {
        // Clear existing clusters
        if (clusterLayers) {
            map.removeLayer(clusterLayers);
        }
        
        clusterLayers = L.layerGroup().addTo(map);
        
        clusterData.pickup_clusters.forEach((center, index) => {
            const clusterInfo = clusterNames[index];
            
            // Add cluster area (2km radius)
            const circle = L.circle(center, {
                radius: 2000, // 2km
                color: clusterInfo.color,
                fillColor: clusterInfo.color,
                fillOpacity: 0.1,
                weight: 2,
                className: 'cluster-area'
            }).addTo(clusterLayers);
            
            clusterAreas.push(circle);
            
            // Add cluster label
            L.marker(center, {
                icon: L.divIcon({
                    className: 'cluster-label',
                    html: `
                        <div class="bg-white px-3 py-1 rounded-lg shadow border text-xs font-semibold" 
                             style="color: ${clusterInfo.color}; border-color: ${clusterInfo.color}">
                            ${clusterInfo.name}
                        </div>
                    `,
                    iconSize: [120, 30]
                })
            }).addTo(clusterLayers);
        });
    }

    // Set current time
    const now = new Date();
    document.getElementById('hour').value = now.getHours();
    document.getElementById('day').value = now.getDay() - 1;

    // MARKER FUNCTIONS
    function setPickupMarker(lat, lng) {
        if (pickupMarker) map.removeLayer(pickupMarker);
        
        pickupMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'pickup-marker',
                html: '<div class="w-8 h-8 bg-green-500 rounded-full border-3 border-white shadow-lg"></div>',
                iconSize: [32, 32]
            })
        }).addTo(map).bindPopup('<b>Lokasi Awal</b>');
        
        document.getElementById('pickup_lat').value = lat;
        document.getElementById('pickup_lon').value = lng;
        
        // Center map on pickup
        map.setView([lat, lng], 13);
    }

    // MAP CLICK HANDLER
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        setPickupMarker(lat, lng);
        reverseGeocode(lat, lng, 'pickup_input');
    });

    // SEARCH FUNCTIONALITY
    function searchLocation(query, resultElementId, inputElementId) {
        if (query.length < 2) {
            document.getElementById(resultElementId).style.display = 'none';
            return;
        }
        
        fetch(`/api/search?q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById(resultElementId);
                list.innerHTML = '';
                
                if (data.length === 0) {
                    const item = document.createElement('div');
                    item.className = 'search-item text-gray-500 italic';
                    item.innerText = 'Lokasi tidak ditemukan';
                    list.appendChild(item);
                } else {
                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'search-item';
                        div.innerHTML = `
                            <div class="flex items-center">
                                <i class="fas fa-map-marker-alt text-gray-400 mr-3 text-sm"></i>
                                <div>
                                    <div class="font-medium">${item.display_name.split(',')[0]}</div>
                                    <div class="text-xs text-gray-500">${item.display_name.split(',').slice(1,3).join(',').substring(0, 50)}...</div>
                                </div>
                            </div>
                        `;
                        div.onclick = () => {
                            document.getElementById(inputElementId).value = item.display_name;
                            setPickupMarker(item.lat, item.lon);
                            list.style.display = 'none';
                        };
                        list.appendChild(div);
                    });
                }
                list.style.display = 'block';
            });
    }

    // Event listeners for search
    document.getElementById('pickup_input').addEventListener('input', (e) => {
        searchLocation(e.target.value, 'pickup_results', 'pickup_input');
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-container')) {
            document.getElementById('pickup_results').style.display = 'none';
        }
    });

    function reverseGeocode(lat, lng, inputId) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
            .then(res => res.json())
            .then(data => {
                if (data.display_name) {
                    document.getElementById(inputId).value = data.display_name;
                }
            });
    }

    // PREDICTION FUNCTION
    function predictDestination() {
        const pLat = document.getElementById('pickup_lat').value;
        
        if (!pLat) {
            alert('Harap pilih lokasi awal terlebih dahulu!');
            return;
        }

        const hour = parseInt(document.getElementById('hour').value);
        const day = parseInt(document.getElementById('day').value);
        const passengers = parseInt(document.getElementById('passengers').value);
        
        // Create datetime string
        const now = new Date();
        const datetime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, 0);
        const datetimeStr = datetime.toISOString().slice(0, 16);

        // Show loading
        const predictBtn = document.getElementById('predictBtn');
        const originalText = predictBtn.innerHTML;
        predictBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Memproses...';
        predictBtn.disabled = true;
        
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('result_section').classList.add('hidden');

        // Clear previous predictions
        predictionMarkers.forEach(marker => map.removeLayer(marker));
        predictionMarkers = [];

        const payload = {
            pickup_lat: pLat,
            pickup_lon: document.getElementById('pickup_lon').value,
            datetime: datetimeStr,
            passengers: passengers
        };

        fetch('/api/predict_destination', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            // Reset button
            predictBtn.innerHTML = originalText;
            predictBtn.disabled = false;
            
            document.getElementById('loading').classList.add('hidden');
            
            if (data.status === 'success') {
                // Display top 3 predictions
                displayTopPredictions(data.top_predictions);
                
                // Show result section
                document.getElementById('result_section').classList.remove('hidden');
                
                // Add prediction markers to map
                data.top_predictions.forEach((pred, index) => {
                    addPredictionMarker(pred, index);
                });
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(err => {
            predictBtn.innerHTML = originalText;
            predictBtn.disabled = false;
            document.getElementById('loading').classList.add('hidden');
            alert('Koneksi gagal. Silakan coba lagi.');
            console.error(err);
        });
    }

    // DISPLAY PREDICTIONS
    function displayTopPredictions(predictions) {
        const container = document.getElementById('top_predictions_grid');
        container.innerHTML = '';
        
        const rankColors = ['#EF4444', '#3B82F6', '#F59E0B'];
        const rankIcons = ['fa-crown', 'fa-medal', 'fa-award'];
        
        predictions.forEach((pred, index) => {
            const card = document.createElement('div');
            card.className = 'prediction-card bg-white rounded-xl p-5 shadow border border-gray-100';
            card.style.borderLeftColor = rankColors[index];
            
            card.innerHTML = `
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center">
                        <div class="rank-badge mr-3" style="background-color: ${rankColors[index]}">
                            ${index + 1}
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-900">${pred.name}</h4>
                            <p class="text-sm text-gray-600">${pred.type}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-bold" style="color: ${rankColors[index]}">
                            ${pred.probability}%
                        </div>
                        <div class="text-xs text-gray-500">probabilitas</div>
                    </div>
                </div>
                
                <div class="text-sm text-gray-600 mb-4">
                    ${pred.description || 'Zona tujuan populer'}
                </div>
                
                <div class="flex items-center justify-between text-sm text-gray-500">
                    <span>Zona ${pred.cluster}</span>
                    <span>${pred.center[0].toFixed(4)}, ${pred.center[1].toFixed(4)}</span>
                </div>
            `;
            
            container.appendChild(card);
        });
    }

    function addPredictionMarker(prediction, rank) {
        const colors = ['#EF4444', '#3B82F6', '#F59E0B'];
        
        const marker = L.marker(prediction.center, {
            icon: L.divIcon({
                className: `prediction-marker rank-${rank}`,
                html: `
                    <div class="relative">
                        <div class="w-10 h-10 rounded-full border-3 border-white shadow-lg flex items-center justify-center text-white font-bold"
                             style="background-color: ${colors[rank]}">
                            ${rank + 1}
                        </div>
                    </div>
                `,
                iconSize: [40, 40]
            })
        }).addTo(map).bindPopup(`
            <div class="p-2">
                <div class="font-bold mb-1" style="color: ${colors[rank]}">${prediction.name}</div>
                <div class="text-sm">Peringkat: #${rank + 1}</div>
                <div class="text-sm">Probabilitas: ${prediction.probability}%</div>
            </div>
        `);
        
        predictionMarkers.push(marker);
    }

    // Initialize
    setTimeout(() => {
        setPickupMarker(40.7489, -73.9680);
        document.getElementById('pickup_input').value = 'Times Square, New York';
        loadClusters();
    }, 500);
</script>
{% endblock %}