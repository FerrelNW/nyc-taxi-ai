{% extends "layout.html" %}

{% block title %}Destination Analysis - NYC Taxi AI{% endblock %}

{% block extra_css %}
<style>
    #map { 
        height: 500px; 
        width: 100%; 
        border-radius: 12px; 
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    
    .search-container { 
        position: relative; 
    }
    
    .search-results {
        position: absolute; 
        top: 100%; 
        left: 0; 
        right: 0;
        background: white; 
        border: 1px solid #e5e7eb;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 250px; 
        overflow-y: auto; 
        z-index: 1000;
        display: none; 
        box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
    }
    
    .search-item { 
        padding: 12px 16px; 
        cursor: pointer; 
        border-bottom: 1px solid #f3f4f6; 
        font-size: 14px; 
        transition: all 0.2s;
        display: flex;
        align-items: flex-start;
    }
    
    .search-item:hover { 
        background-color: #f0f9ff; 
    }
    
    .search-icon {
        color: #6b7280;
        margin-right: 12px;
        margin-top: 2px;
    }
    
    .cluster-polygon {
        fill-opacity: 0.25;
        stroke-width: 3;
        stroke-opacity: 0.8;
        transition: all 0.3s;
    }
    
    .cluster-polygon:hover {
        fill-opacity: 0.35;
        stroke-width: 4;
    }
    
    .cluster-label {
        font-weight: bold;
        font-size: 14px;
        text-shadow: 1px 1px 2px white;
        pointer-events: none;
    }
    
    .prediction-card {
        border-left: 4px solid;
        transition: transform 0.3s, box-shadow 0.3s;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .prediction-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    .rank-badge {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .input-enhanced {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        font-size: 14px;
        transition: all 0.2s;
        background: white;
    }
    
    .input-enhanced:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .input-enhanced.with-icon {
        padding-left: 44px;
    }
    
    .label-enhanced {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
    }
    
    .card-enhanced {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #e5e7eb;
    }
    
    .btn-secondary {
        width: 100%;
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        font-weight: 600;
        padding: 16px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-secondary:hover {
        background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.3);
    }
    
    .btn-secondary:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .click-instruction {
        font-size: 12px;
        color: #6b7280;
        margin-top: 8px;
        padding: 8px 12px;
        background: #f9fafb;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }
    
    .input-group {
        position: relative;
        margin-bottom: 20px;
    }
    
    .input-icon {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: #6b7280;
        pointer-events: none;
    }
    
    .input-label {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        font-weight: 600;
        color: #374151;
    }
    
    .input-label i {
        margin-right: 8px;
        width: 16px;
    }
    
    .probability-bar {
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
        margin: 8px 0;
    }
    
    .probability-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 1s ease-out;
    }
    
    .cluster-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 16px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        font-size: 11px;
        padding: 4px 8px;
        background: white;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .legend-item:hover {
        background: #f9fafb;
        transform: translateY(-1px);
    }
    
    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 6px;
        border: 2px solid white;
        box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
    }
    
    .cluster-info-window {
        background: white;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        max-width: 300px;
        border: 2px solid;
    }
    
    .zone-coverage {
        position: absolute;
        top: 16px;
        right: 16px;
        background: white;
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 12px;
        font-weight: 600;
        color: #374151;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        z-index: 1000;
        border: 1px solid #e5e7eb;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">NYC Taxi Destination Prediction</h1>
        <p class="text-gray-600">Predict top 3 destination zones based on pickup location and time</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Panel: Input -->
        <div class="lg:col-span-1">
            <div class="card-enhanced h-full">
                <h2 class="text-xl font-bold text-gray-900 mb-6">Input Data</h2>

                <!-- Time Selection -->
                <div class="mb-6">
                    <label class="input-label">
                        <i class="far fa-clock text-purple-500"></i>
                        Time
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">Hour</label>
                            <select id="hour" class="input-enhanced">
                                {% for h in range(24) %}
                                <option value="{{ h }}" {% if h==now.hour %}selected{% endif %}>{{ "%02d"|format(h) }}:00</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">Day</label>
                            <select id="day" class="input-enhanced">
                                <option value="0">Monday</option>
                                <option value="1">Tuesday</option>
                                <option value="2">Wednesday</option>
                                <option value="3">Thursday</option>
                                <option value="4">Friday</option>
                                <option value="5">Saturday</option>
                                <option value="6">Sunday</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Passengers -->
                <div class="mb-6">
                    <label class="input-label">
                        <i class="fas fa-users text-purple-500"></i>
                        Passengers
                    </label>
                    <input type="number" id="passengers" min="1" max="6" value="1"
                           class="input-enhanced">
                </div>

                <!-- Pickup Location -->
                <div class="mb-8">
                    <label class="input-label">
                        <i class="fas fa-map-pin text-green-500"></i>
                        Pickup Location
                    </label>
                    <div class="search-container">
                        <div class="relative">
                            <input type="text" id="pickup_input" 
                                   class="input-enhanced with-icon"
                                   placeholder="Search pickup location...">
                            <i class="fas fa-search input-icon"></i>
                        </div>
                        <div id="pickup_results" class="search-results"></div>
                    </div>
                    <div class="click-instruction">
                        <i class="fas fa-mouse-pointer text-green-500 mr-1"></i>
                        Click on map or search above to set pickup location
                    </div>
                    <input type="hidden" id="pickup_lat">
                    <input type="hidden" id="pickup_lon">
                </div>

                <!-- Predict Button -->
                <button onclick="predictDestination()" id="predictBtn"
                        class="btn-secondary">
                    <i class="fas fa-bullseye mr-3 text-lg"></i>
                    <span>Predict Destination</span>
                </button>

                <!-- Loading -->
                <div id="loading" class="hidden mt-6">
                    <div class="flex flex-col items-center justify-center p-6">
                        <div class="relative mb-4">
                            <div class="w-12 h-12 border-4 border-purple-100 rounded-full"></div>
                            <div class="absolute top-0 left-0 w-12 h-12 border-4 border-purple-600 rounded-full border-t-transparent animate-spin"></div>
                        </div>
                        <p class="text-gray-600 font-medium">Analyzing travel patterns...</p>
                        <p class="text-sm text-gray-500 mt-1">Processing with LightGBM model</p>
                    </div>
                </div>

                <!-- Current Zone Info -->
                <div id="current_zone_info" class="hidden mt-6 p-4 bg-purple-50 rounded-xl border border-purple-200">
                    <h4 class="font-semibold text-purple-800 mb-2">Current Zone</h4>
                    <div class="flex items-center mb-2">
                        <div id="zone_color" class="w-4 h-4 rounded-full mr-2"></div>
                        <span id="zone_name" class="font-medium text-gray-800">--</span>
                    </div>
                    <p id="zone_type" class="text-sm text-gray-600">--</p>
                </div>
                
                <!-- Legend -->
                <div id="legend_container" class="hidden mt-6">
                    <h4 class="font-semibold text-gray-800 mb-2">10 NYC Taxi Zones</h4>
                    <div class="cluster-legend" id="zone_legend">
                        <!-- Legend will be generated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Map and Results -->
        <div class="lg:col-span-2">
            <!-- Map -->
            <div class="card-enhanced mb-8 relative">
                <div class="absolute top-4 left-4 z-10 bg-white/90 backdrop-blur-sm rounded-xl px-4 py-2 shadow-lg">
                    <h3 class="font-semibold text-gray-800">NYC Taxi Zones Map</h3>
                    <p class="text-xs text-gray-500">10 zones covering entire NYC</p>
                </div>
                
                <div class="zone-coverage">
                    <i class="fas fa-layer-group text-purple-500 mr-1"></i>
                    Full Coverage
                </div>
                
                <div id="map" class="h-[400px] rounded-xl"></div>
                
                <div class="mt-4 flex flex-wrap gap-4 text-sm">
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded-full bg-green-500 mr-2 shadow"></div>
                        <span class="text-gray-700 font-medium">Pickup</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded-full bg-red-500 mr-2 shadow"></div>
                        <span class="text-gray-700 font-medium">Top 1</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded-full bg-blue-500 mr-2 shadow"></div>
                        <span class="text-gray-700 font-medium">Top 2</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded-full bg-yellow-500 mr-2 shadow"></div>
                        <span class="text-gray-700 font-medium">Top 3</span>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div id="result_section" class="hidden">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Top 3 Destination Predictions</h3>
                    <span id="model_info" class="text-sm text-gray-500 bg-purple-100 text-purple-700 px-3 py-1 rounded-full">LightGBM Model</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="top_predictions_grid">
                    <!-- Results will be inserted here -->
                </div>
                
                <!-- Pattern Analysis -->
                <div id="pattern_analysis" class="hidden mt-8">
                    <div class="card-enhanced">
                        <h4 class="font-semibold text-gray-800 mb-3">Pattern Analysis</h4>
                        <p class="text-gray-600" id="analysis_text">--</p>
                        <div class="mt-4 flex items-center text-sm text-purple-600">
                            <i class="fas fa-chart-line mr-2"></i>
                            <span>Based on historical taxi trip data</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Zone Details -->
            <div id="zone_details" class="hidden mt-6">
                <div class="card-enhanced">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-900" id="zone_title">Zone Details</h3>
                        <button onclick="hideZoneDetails()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <div class="flex items-center mb-4">
                                <div id="detail_color" class="w-6 h-6 rounded-full mr-3"></div>
                                <div>
                                    <h4 id="detail_name" class="font-bold text-gray-900">--</h4>
                                    <p id="detail_type" class="text-sm text-gray-600">--</p>
                                </div>
                            </div>
                            <p id="detail_description" class="text-gray-600 text-sm">--</p>
                        </div>
                        <div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h5 class="font-semibold text-gray-800 mb-2">Zone Statistics</h5>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">Center Coordinates:</span>
                                        <span id="detail_coords" class="font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">Coverage Radius:</span>
                                        <span class="font-semibold">3.0 km</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">Zone ID:</span>
                                        <span id="detail_id" class="font-bold">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize map
    const map = L.map('map').setView([40.7580, -73.9855], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '© OpenStreetMap'
    }).addTo(map);

    let pickupMarker = null;
    let clusterLayers = [];
    let clusterPolygons = [];
    let predictionMarkers = [];
    let selectedZone = null;

    // Set current time
    const now = new Date();
    document.getElementById('hour').value = now.getHours();
    document.getElementById('day').value = now.getDay() - 1;

    // MARKER FUNCTIONS
    function setPickupMarker(lat, lng) {
        if (pickupMarker) map.removeLayer(pickupMarker);
        
        pickupMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'pickup-marker',
                html: `
                    <div class="relative">
                        <div class="w-10 h-10 bg-green-500 rounded-full border-3 border-white shadow-lg flex items-center justify-center">
                            <i class="fas fa-map-marker-alt text-white"></i>
                        </div>
                        <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-4 h-4 bg-green-500 rotate-45 border-b border-r border-white"></div>
                    </div>
                `,
                iconSize: [40, 50]
            })
        }).addTo(map).bindPopup('<b>Pickup Location</b>');
        
        document.getElementById('pickup_lat').value = lat;
        document.getElementById('pickup_lon').value = lng;
        
        // Center map on pickup
        map.setView([lat, lng], 13);
        
        // Get zone info for this location
        getZoneInfo(lat, lng);
    }

    // MAP CLICK HANDLER
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        // Add ripple effect
        const ripple = L.circle(e.latlng, {
            radius: 20,
            color: '#10B981',
            fillColor: '#10B981',
            fillOpacity: 0.3,
            weight: 0
        }).addTo(map);
        
        setTimeout(() => {
            map.removeLayer(ripple);
        }, 500);
        
        setPickupMarker(lat, lng);
        reverseGeocode(lat, lng, 'pickup_input');
    });

    // Load clusters from API with larger coverage
    function loadClusters() {
        fetch('/api/clusters')
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    displayClusters(data.clusters);
                    createLegend(data.clusters);
                }
            });
    }

    // Function to create Voronoi-like polygons covering entire NYC
    function createVoronoiPolygons(clusters) {
        // Define NYC bounds
        const nycBounds = [
            [40.495, -74.255], // SW
            [40.917, -73.700]  // NE
        ];
        
        // Create Voronoi diagram using Delaunay triangulation (simplified)
        const points = clusters.map(c => [c.center[0], c.center[1]]);
        
        // For each cluster, create a polygon that covers area closer to it than other clusters
        clusters.forEach((cluster, index) => {
            // Create a large circle (3km radius) around cluster center
            const circle = L.circle(cluster.center, {
                radius: 3000, // 3km for full coverage
                color: cluster.color,
                fillColor: cluster.color,
                fillOpacity: 0.2,
                weight: 2.5,
                className: 'cluster-polygon'
            }).addTo(map);
            
            // Add cluster label
            const label = L.marker(cluster.center, {
                icon: L.divIcon({
                    className: 'cluster-label',
                    html: `
                        <div class="bg-white/90 backdrop-blur-sm px-3 py-2 rounded-lg shadow-lg border flex items-center" 
                             style="color: ${cluster.color}; border-color: ${cluster.color}">
                            <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${cluster.color}"></div>
                            <span class="font-bold">Zone ${cluster.id}</span>
                        </div>
                    `,
                    iconSize: [80, 40]
                })
            }).addTo(map);
            
            // Add click events
            circle.on('click', (e) => {
                e.originalEvent.stopPropagation();
                showZoneDetails(cluster);
            });
            
            label.on('click', (e) => {
                e.originalEvent.stopPropagation();
                showZoneDetails(cluster);
            });
            
            // Add hover effects
            circle.on('mouseover', () => {
                circle.setStyle({
                    fillOpacity: 0.35,
                    weight: 3.5
                });
            });
            
            circle.on('mouseout', () => {
                if (selectedZone !== cluster.id) {
                    circle.setStyle({
                        fillOpacity: 0.2,
                        weight: 2.5
                    });
                }
            });
            
            clusterPolygons.push(circle);
            clusterLayers.push(circle);
            clusterLayers.push(label);
        });
    }

    function displayClusters(clusters) {
        // Clear existing layers
        clusterLayers.forEach(layer => map.removeLayer(layer));
        clusterLayers = [];
        clusterPolygons = [];
        
        // Create larger coverage polygons
        createVoronoiPolygons(clusters);
        
        // Show legend
        document.getElementById('legend_container').classList.remove('hidden');
    }

    function createLegend(clusters) {
        const container = document.getElementById('zone_legend');
        container.innerHTML = '';
        
        clusters.forEach(cluster => {
            const item = document.createElement('div');
            item.className = 'legend-item';
            item.dataset.zoneId = cluster.id;
            
            item.innerHTML = `
                <div class="legend-color" style="background-color: ${cluster.color}"></div>
                <span>Zone ${cluster.id}</span>
            `;
            
            item.addEventListener('click', () => {
                showZoneDetails(cluster);
                map.setView(cluster.center, 12);
            });
            
            container.appendChild(item);
        });
    }

    // SEARCH FUNCTIONALITY
    function searchLocation(query, resultElementId, inputElementId) {
        if (query.length < 2) {
            document.getElementById(resultElementId).style.display = 'none';
            return;
        }
        
        fetch(`/api/search?q=${encodeURIComponent(query)}&limit=5`)
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById(resultElementId);
                list.innerHTML = '';
                
                if (data.length === 0) {
                    const item = document.createElement('div');
                    item.className = 'search-item';
                    item.innerHTML = `
                        <div class="search-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <div>
                            <div class="font-medium">No results found</div>
                            <div class="text-xs text-gray-500">Try a different search term</div>
                        </div>
                    `;
                    list.appendChild(item);
                } else {
                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'search-item';
                        div.innerHTML = `
                            <div class="search-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div>
                                <div class="font-medium">${item.display_name.split(',')[0]}</div>
                                <div class="text-xs text-gray-500">${formatAddress(item.display_name)}</div>
                            </div>
                        `;
                        div.onclick = () => {
                            document.getElementById(inputElementId).value = item.display_name;
                            setPickupMarker(item.lat, item.lon);
                            list.style.display = 'none';
                        };
                        list.appendChild(div);
                    });
                }
                list.style.display = 'block';
            });
    }

    function formatAddress(fullAddress) {
        const parts = fullAddress.split(',');
        if (parts.length <= 3) return fullAddress;
        return parts.slice(1, 4).join(', ').substring(0, 60) + '...';
    }

    // Event listeners for search
    document.getElementById('pickup_input').addEventListener('input', (e) => {
        searchLocation(e.target.value, 'pickup_results', 'pickup_input');
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-container')) {
            document.getElementById('pickup_results').style.display = 'none';
        }
    });

    function reverseGeocode(lat, lng, inputId) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18`)
            .then(res => res.json())
            .then(data => {
                if (data.display_name) {
                    document.getElementById(inputId).value = data.display_name;
                }
            });
    }

    // Get zone info for current location
    function getZoneInfo(lat, lng) {
        fetch('/api/clusters')
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    // Find the nearest cluster
                    let nearestCluster = null;
                    let minDistance = Infinity;
                    
                    data.clusters.forEach(cluster => {
                        const distance = Math.sqrt(
                            Math.pow(cluster.center[0] - lat, 2) + 
                            Math.pow(cluster.center[1] - lng, 2)
                        ) * 111; // Convert to km
                        
                        if (distance < minDistance) {
                            minDistance = distance;
                            nearestCluster = cluster;
                        }
                    });
                    
                    if (nearestCluster && minDistance < 5) { // Within 5km
                        displayZoneInfo(nearestCluster);
                    } else {
                        document.getElementById('current_zone_info').classList.add('hidden');
                    }
                }
            });
    }

    function displayZoneInfo(cluster) {
        document.getElementById('current_zone_info').classList.remove('hidden');
        document.getElementById('zone_color').style.backgroundColor = cluster.color;
        document.getElementById('zone_name').textContent = `Zone ${cluster.id}: ${cluster.name}`;
        document.getElementById('zone_type').textContent = cluster.type;
    }

    function showZoneDetails(cluster) {
        // Highlight selected zone
        if (selectedZone !== null && selectedZone !== cluster.id) {
            clusterPolygons.forEach(poly => {
                poly.setStyle({
                    fillOpacity: 0.2,
                    weight: 2.5
                });
            });
        }
        
        // Highlight the selected zone
        const selectedPoly = clusterPolygons.find(poly => 
            poly.getLatLng().lat === cluster.center[0] &&
            poly.getLatLng().lng === cluster.center[1]
        );
        
        if (selectedPoly) {
            selectedPoly.setStyle({
                fillOpacity: 0.4,
                weight: 4,
                color: cluster.color
            });
            selectedPoly.bringToFront();
        }
        
        selectedZone = cluster.id;
        
        // Update details panel
        document.getElementById('zone_title').textContent = `Zone ${cluster.id} Details`;
        document.getElementById('detail_color').style.backgroundColor = cluster.color;
        document.getElementById('detail_name').textContent = cluster.name;
        document.getElementById('detail_type').textContent = cluster.type;
        document.getElementById('detail_description').textContent = cluster.description;
        document.getElementById('detail_coords').textContent = 
            `${cluster.center[0].toFixed(4)}, ${cluster.center[1].toFixed(4)}`;
        document.getElementById('detail_id').textContent = cluster.id;
        
        // Show details panel
        document.getElementById('zone_details').classList.remove('hidden');
        
        // Center map on zone
        map.setView(cluster.center, 12);
    }

    function hideZoneDetails() {
        document.getElementById('zone_details').classList.add('hidden');
        
        // Reset zone styles
        if (selectedZone !== null) {
            clusterPolygons.forEach(poly => {
                poly.setStyle({
                    fillOpacity: 0.2,
                    weight: 2.5
                });
            });
            selectedZone = null;
        }
    }

    // PREDICTION FUNCTION
    function predictDestination() {
        const pLat = document.getElementById('pickup_lat').value;
        
        if (!pLat) {
            alert('Please select a pickup location first!');
            return;
        }

        const hour = parseInt(document.getElementById('hour').value);
        const day = parseInt(document.getElementById('day').value);
        const passengers = parseInt(document.getElementById('passengers').value);
        
        // Create datetime string
        const now = new Date();
        const datetime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, 0);
        const datetimeStr = datetime.toISOString().slice(0, 16);

        // Show loading
        const predictBtn = document.getElementById('predictBtn');
        const originalText = predictBtn.innerHTML;
        predictBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Predicting...';
        predictBtn.disabled = true;
        
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('result_section').classList.add('hidden');
        document.getElementById('pattern_analysis').classList.add('hidden');

        // Clear previous predictions
        predictionMarkers.forEach(marker => map.removeLayer(marker));
        predictionMarkers = [];

        const payload = {
            pickup_lat: pLat,
            pickup_lon: document.getElementById('pickup_lon').value,
            datetime: datetimeStr,
            passengers: passengers
        };

        fetch('/api/predict_destination', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            // Reset button
            predictBtn.innerHTML = originalText;
            predictBtn.disabled = false;
            
            document.getElementById('loading').classList.add('hidden');
            
            if (data.status === 'success') {
                // Update model info
                document.getElementById('model_info').textContent = 
                    `LightGBM · ${data.total_clusters} Zones`;
                
                // Display top 3 predictions
                displayTopPredictions(data.top_predictions);
                
                // Show result section
                document.getElementById('result_section').classList.remove('hidden');
                
                // Add prediction markers to map
                data.top_predictions.forEach((pred, index) => {
                    addPredictionMarker(pred, index);
                });
                
                // Show pattern analysis
                displayPatternAnalysis(data, hour);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(err => {
            predictBtn.innerHTML = originalText;
            predictBtn.disabled = false;
            document.getElementById('loading').classList.add('hidden');
            alert('Connection failed. Please try again.');
            console.error(err);
        });
    }

    // DISPLAY PREDICTIONS
    function displayTopPredictions(predictions) {
        const container = document.getElementById('top_predictions_grid');
        container.innerHTML = '';
        
        const rankColors = ['#EF4444', '#3B82F6', '#F59E0B'];
        const rankIcons = ['fa-crown', 'fa-medal', 'fa-award'];
        
        predictions.forEach((pred, index) => {
            const card = document.createElement('div');
            card.className = 'prediction-card bg-white shadow-lg';
            card.style.borderLeftColor = rankColors[index];
            
            card.innerHTML = `
                <div class="p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center">
                            <div class="rank-badge mr-4" style="background-color: ${rankColors[index]}">
                                <i class="fas ${rankIcons[index]}"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-900 text-lg">${pred.name}</h4>
                                <p class="text-sm text-gray-600">${pred.type}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold" style="color: ${rankColors[index]}">
                                ${pred.probability}%
                            </div>
                            <div class="text-xs text-gray-500">${pred.confidence} Confidence</div>
                        </div>
                    </div>
                    
                    <div class="probability-bar">
                        <div class="probability-fill" style="width: ${pred.probability}%; background-color: ${rankColors[index]};"></div>
                    </div>
                    
                    <div class="text-sm text-gray-600 mt-4 mb-6">
                        ${pred.description}
                    </div>
                    
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${pred.color}"></div>
                            <span class="px-3 py-1 rounded-full bg-gray-100 text-gray-700">Zone ${pred.cluster}</span>
                        </div>
                        <button onclick="showZoneDetailsById(${pred.cluster})" class="text-purple-600 hover:text-purple-700 font-medium">
                            <i class="fas fa-info-circle mr-1"></i>
                            Details
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(card);
        });
    }

    function showZoneDetailsById(zoneId) {
        fetch('/api/clusters')
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    const cluster = data.clusters.find(c => c.id === zoneId);
                    if (cluster) {
                        showZoneDetails(cluster);
                    }
                }
            });
    }

    function addPredictionMarker(prediction, rank) {
        const colors = ['#EF4444', '#3B82F6', '#F59E0B'];
        const icons = ['fa-trophy', 'fa-medal', 'fa-award'];
        
        const marker = L.marker(prediction.center, {
            icon: L.divIcon({
                className: `prediction-marker rank-${rank}`,
                html: `
                    <div class="relative">
                        <div class="w-12 h-12 rounded-full border-4 border-white shadow-xl flex items-center justify-center text-white font-bold"
                             style="background-color: ${colors[rank]}">
                            <i class="fas ${icons[rank]}"></i>
                        </div>
                        <div class="absolute -bottom-1 left-1/2 transform -translate-x-1/2 w-4 h-4 ${rank === 0 ? 'bg-red-500' : rank === 1 ? 'bg-blue-500' : 'bg-yellow-500'} rotate-45 border-b border-r border-white"></div>
                    </div>
                `,
                iconSize: [48, 58]
            })
        }).addTo(map).bindPopup(`
            <div class="p-3 min-w-[220px]">
                <div class="font-bold text-lg mb-2" style="color: ${colors[rank]}">
                    #${rank + 1}: ${prediction.name}
                </div>
                <div class="text-sm mb-3">${prediction.type}</div>
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm">Probability:</span>
                    <span class="font-bold" style="color: ${colors[rank]}">${prediction.probability}%</span>
                </div>
                <div class="text-xs text-gray-500">${prediction.description}</div>
            </div>
        `);
        
        predictionMarkers.push(marker);
        
        // Center map on all prediction markers
        if (predictionMarkers.length === 3) {
            const bounds = L.latLngBounds();
            predictionMarkers.forEach(marker => {
                bounds.extend(marker.getLatLng());
            });
            if (pickupMarker) {
                bounds.extend(pickupMarker.getLatLng());
            }
            map.fitBounds(bounds, { padding: [100, 100] });
        }
    }

    function displayPatternAnalysis(data, hour) {
        const analysisDiv = document.getElementById('pattern_analysis');
        const textDiv = document.getElementById('analysis_text');
        
        const day = data.day_of_week;
        const pickupZone = data.pickup_cluster_name;
        const topPrediction = data.top_predictions[0];
        
        let analysis = `Analysis for <strong>${day} at ${hour}:00</strong> from <strong>${pickupZone}</strong>: `;
        
        if (hour >= 6 && hour <= 9) {
            analysis += "Morning rush hour patterns show strong preference for business districts and commercial areas. ";
        } else if (hour >= 17 && hour <= 20) {
            analysis += "Evening patterns indicate travel towards residential and dining areas. ";
        } else if (hour >= 21 || hour <= 3) {
            analysis += "Late night patterns show entertainment and nightlife destinations as most likely. ";
        } else {
            analysis += "Daytime patterns suggest mixed commercial and tourist destinations. ";
        }
        
        analysis += `The highest probability destination is <strong>${topPrediction.name}</strong> with ${topPrediction.probability}% confidence.`;
        
        textDiv.innerHTML = analysis;
        analysisDiv.classList.remove('hidden');
    }

    function clearMap() {
        if (pickupMarker) {
            map.removeLayer(pickupMarker);
            pickupMarker = null;
        }
        document.getElementById('pickup_input').value = '';
        document.getElementById('pickup_lat').value = '';
        document.getElementById('pickup_lon').value = '';
        document.getElementById('current_zone_info').classList.add('hidden');
        document.getElementById('result_section').classList.add('hidden');
        document.getElementById('pattern_analysis').classList.add('hidden');
        document.getElementById('zone_details').classList.add('hidden');
        
        // Clear prediction markers
        predictionMarkers.forEach(marker => map.removeLayer(marker));
        predictionMarkers = [];
        
        // Reset zone styles
        if (selectedZone !== null) {
            clusterPolygons.forEach(poly => {
                poly.setStyle({
                    fillOpacity: 0.2,
                    weight: 2.5
                });
            });
            selectedZone = null;
        }
        
        // Reset map view
        map.setView([40.7580, -73.9855], 11);
    }

    // Initialize
    setTimeout(() => {
        setPickupMarker(40.7489, -73.9680);
        document.getElementById('pickup_input').value = 'Times Square, New York';
        reverseGeocode(40.7489, -73.9680, 'pickup_input');
        loadClusters(); // Load clusters immediately with larger coverage
    }, 1000);
</script>

<style>
    .cluster-polygon {
        animation: pulse-glow 3s infinite;
    }
    
    @keyframes pulse-glow {
        0% { filter: brightness(1); }
        50% { filter: brightness(1.1); }
        100% { filter: brightness(1); }
    }
    
    .prediction-card {
        animation: slideUp 0.5s ease-out;
    }
    
    @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}