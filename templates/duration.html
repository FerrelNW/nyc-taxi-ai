{% extends "layout.html" %}

{% block title %}Estimasi Durasi - NYC Taxi AI{% endblock %}

{% block extra_css %}
<style>
    #map { height: 500px; width: 100%; border-radius: 12px; }
    .search-container { position: relative; }
    .search-results {
        position: absolute; top: 100%; left: 0; right: 0;
        background: white; border: 1px solid #ddd; border-radius: 0 0 8px 8px;
        max-height: 200px; overflow-y: auto; z-index: 1000;
        display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f3f3f3; font-size: 14px; }
    .search-item:hover { background-color: #f0f9ff; color: #0284c7; }
    .marker-pickup { background-color: #10b981; }
    .marker-dropoff { background-color: #ef4444; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex items-center mb-2">
            <a href="/" class="text-blue-600 hover:text-blue-800">
                <i class="fas fa-home"></i> Home
            </a>
            <span class="mx-2 text-gray-400">/</span>
            <span class="text-gray-700">Estimasi Durasi</span>
        </div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Estimasi Durasi Perjalanan Taksi</h1>
        <p class="text-gray-600">Hitung waktu tempuh antara dua lokasi di New York City</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Panel: Input Form -->
        <div class="lg:col-span-1">
            <div class="glass-card rounded-xl p-6 shadow-soft h-full">
                <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-sliders-h text-blue-600 mr-3"></i> Parameter Perjalanan
                </h2>

                <!-- Pickup Location -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-map-marker-alt text-green-500 mr-2"></i> Lokasi Penjemputan
                    </label>
                    <div class="search-container">
                        <input type="text" id="pickup_input" 
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Ketik nama tempat atau klik peta...">
                        <div id="pickup_results" class="search-results"></div>
                    </div>
                    <input type="hidden" id="pickup_lat">
                    <input type="hidden" id="pickup_lon">
                    <p class="text-xs text-gray-500 mt-1">Contoh: Times Square, JFK Airport</p>
                </div>

                <!-- Dropoff Location -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-map-marker-alt text-red-500 mr-2"></i> Lokasi Tujuan
                    </label>
                    <div class="search-container">
                        <input type="text" id="dropoff_input" 
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Ketik nama tempat atau klik peta...">
                        <div id="dropoff_results" class="search-results"></div>
                    </div>
                    <input type="hidden" id="dropoff_lat">
                    <input type="hidden" id="dropoff_lon">
                </div>

                <!-- Time and Passengers -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="far fa-clock text-gray-500 mr-2"></i> Waktu
                        </label>
                        <input type="datetime-local" id="datetime" 
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-users text-gray-500 mr-2"></i> Penumpang
                        </label>
                        <input type="number" id="passengers" min="1" max="6" value="1"
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Info Box -->
                <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 mb-6">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-blue-500 mt-0.5 mr-3"></i>
                        <div>
                            <h4 class="font-medium text-blue-800 mb-1">Tips Akurasi</h4>
                            <p class="text-sm text-blue-700">
                                • Pilih titik dengan klik peta untuk presisi tinggi<br>
                                • Model memperhitungkan jam sibuk dan akhir pekan<br>
                                • Hasil berdasarkan data historis NYC taxi
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Predict Button -->
                <button onclick="predictDuration()" 
                        class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white font-medium py-3.5 rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-300 shadow-md hover:shadow-lg flex items-center justify-center">
                    <i class="fas fa-calculator mr-3"></i> Hitung Estimasi Durasi
                </button>

                <!-- Loading Indicator -->
                <div id="loading" class="hidden mt-6 text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <p class="text-gray-600 mt-2">Menganalisis rute dan memprediksi...</p>
                </div>
            </div>
        </div>

        <!-- Right Panel: Map and Results -->
        <div class="lg:col-span-2 space-y-8">
            <!-- Map -->
            <div class="glass-card rounded-xl p-1 shadow-soft overflow-hidden">
                <div id="map"></div>
                <div class="p-4 bg-gray-50 flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                            <span class="text-sm text-gray-700">Jemput</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                            <span class="text-sm text-gray-700">Tujuan</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                            <span class="text-sm text-gray-700">Rute</span>
                        </div>
                    </div>
                    <button onclick="clearMarkers()" class="text-sm text-gray-600 hover:text-red-600">
                        <i class="fas fa-trash-alt mr-1"></i> Hapus Marker
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="result_section" class="hidden">
                <div class="glass-card rounded-xl p-6 shadow-soft">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-chart-line text-green-600 mr-3"></i> Hasil Estimasi
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <!-- Duration Card -->
                        <div class="bg-gradient-to-br from-blue-50 to-white border border-blue-100 rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-blue-800">Durasi Perjalanan</h3>
                                <i class="fas fa-clock text-2xl text-blue-400"></i>
                            </div>
                            <div class="flex items-end">
                                <span id="res_duration" class="text-4xl font-bold text-gray-800">--</span>
                                <span class="text-lg text-gray-500 ml-2 mb-1">menit</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">Waktu tempuh estimasi</p>
                        </div>

                        <!-- Distance Card -->
                        <div class="bg-gradient-to-br from-green-50 to-white border border-green-100 rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-green-800">Jarak Tempuh</h3>
                                <i class="fas fa-road text-2xl text-green-400"></i>
                            </div>
                            <div class="flex items-end">
                                <span id="res_distance" class="text-4xl font-bold text-gray-800">--</span>
                                <span class="text-lg text-gray-500 ml-2 mb-1">km</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">Jarak garis lurus</p>
                        </div>

                        <!-- Cluster Info Card -->
                        <div class="bg-gradient-to-br from-purple-50 to-white border border-purple-100 rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-purple-800">Analisis Zona</h3>
                                <i class="fas fa-map-signs text-2xl text-purple-400"></i>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Zona Jemput:</span>
                                    <span id="res_p_cluster" class="font-semibold text-gray-800">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Zona Tujuan:</span>
                                    <span id="res_d_cluster" class="font-semibold text-gray-800">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Info -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-medium text-gray-800 mb-3">Detail Perjalanan</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <p class="text-xs text-gray-500">Waktu Dipilih</p>
                                <p id="res_time" class="font-medium">--:--</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Jumlah Penumpang</p>
                                <p id="res_passengers" class="font-medium">--</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Koordinat Jemput</p>
                                <p id="res_p_coords" class="font-medium text-sm">--</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Koordinat Tujuan</p>
                                <p id="res_d_coords" class="font-medium text-sm">--</p>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex space-x-3 mt-6">
                        <button onclick="predictDuration()" class="flex-1 bg-blue-600 text-white py-2.5 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-redo mr-2"></i> Hitung Ulang
                        </button>
                        <button onclick="shareResults()" class="flex-1 bg-gray-200 text-gray-800 py-2.5 rounded-lg hover:bg-gray-300 transition-colors">
                            <i class="fas fa-share-alt mr-2"></i> Bagikan
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // --- 1. INITIALIZE MAP ---
    const map = L.map('map').setView([40.7580, -73.9855], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    let pickupMarker = null;
    let dropoffMarker = null;
    let routeLine = null;

    // Set default datetime to now
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('datetime').value = now.toISOString().slice(0, 16);

    // --- 2. MAP CLICK HANDLER ---
    let clickMode = 'pickup';
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        if (!pickupMarker) {
            setPickupMarker(lat, lng);
            reverseGeocode(lat, lng, 'pickup_input');
        } else if (!dropoffMarker) {
            setDropoffMarker(lat, lng);
            reverseGeocode(lat, lng, 'dropoff_input');
            drawRoute();
        } else {
            // Both markers exist, cycle
            map.removeLayer(pickupMarker);
            map.removeLayer(dropoffMarker);
            if (routeLine) map.removeLayer(routeLine);
            pickupMarker = null;
            dropoffMarker = null;
            setPickupMarker(lat, lng);
            reverseGeocode(lat, lng, 'pickup_input');
        }
    });

    // --- 3. MARKER FUNCTIONS ---
    function setPickupMarker(lat, lng) {
        if (pickupMarker) map.removeLayer(pickupMarker);
        pickupMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'custom-marker',
                html: '<div class="marker-pickup w-6 h-6 rounded-full border-2 border-white shadow-md"></div>',
                iconSize: [24, 24]
            }),
            draggable: true
        }).addTo(map).bindPopup('<b>Lokasi Penjemputan</b>');
        
        document.getElementById('pickup_lat').value = lat;
        document.getElementById('pickup_lon').value = lng;

        pickupMarker.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            document.getElementById('pickup_lat').value = pos.lat;
            document.getElementById('pickup_lon').value = pos.lng;
            reverseGeocode(pos.lat, pos.lng, 'pickup_input');
            if (dropoffMarker) drawRoute();
        });
    }

    function setDropoffMarker(lat, lng) {
        if (dropoffMarker) map.removeLayer(dropoffMarker);
        dropoffMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'custom-marker',
                html: '<div class="marker-dropoff w-6 h-6 rounded-full border-2 border-white shadow-md"></div>',
                iconSize: [24, 24]
            }),
            draggable: true
        }).addTo(map).bindPopup('<b>Lokasi Tujuan</b>');
        
        document.getElementById('dropoff_lat').value = lat;
        document.getElementById('dropoff_lon').value = lng;

        dropoffMarker.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            document.getElementById('dropoff_lat').value = pos.lat;
            document.getElementById('dropoff_lon').value = pos.lng;
            reverseGeocode(pos.lat, pos.lng, 'dropoff_input');
            drawRoute();
        });
    }

    function clearMarkers() {
        if (pickupMarker) {
            map.removeLayer(pickupMarker);
            pickupMarker = null;
        }
        if (dropoffMarker) {
            map.removeLayer(dropoffMarker);
            dropoffMarker = null;
        }
        if (routeLine) {
            map.removeLayer(routeLine);
            routeLine = null;
        }
        document.getElementById('pickup_input').value = '';
        document.getElementById('dropoff_input').value = '';
        document.getElementById('pickup_lat').value = '';
        document.getElementById('pickup_lon').value = '';
        document.getElementById('dropoff_lat').value = '';
        document.getElementById('dropoff_lon').value = '';
        document.getElementById('result_section').classList.add('hidden');
    }

    // --- 4. SEARCH & GEOCODING ---
    function searchLocation(query, resultElementId, inputElementId) {
        if (query.length < 3) {
            document.getElementById(resultElementId).style.display = 'none';
            return;
        }
        
        fetch(`/api/search?q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById(resultElementId);
                list.innerHTML = '';
                
                if (data.length === 0) {
                    const item = document.createElement('div');
                    item.className = 'search-item text-gray-500';
                    item.innerText = 'Tidak ditemukan';
                    list.appendChild(item);
                } else {
                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'search-item';
                        div.innerHTML = `
                            <div class="font-medium">${item.display_name.split(',')[0]}</div>
                            <div class="text-xs text-gray-500">${item.display_name.split(',').slice(1,3).join(',')}</div>
                        `;
                        div.onclick = () => {
                            document.getElementById(inputElementId).value = item.display_name;
                            if (inputElementId === 'pickup_input') {
                                setPickupMarker(item.lat, item.lon);
                            } else {
                                setDropoffMarker(item.lat, item.lon);
                                if (pickupMarker) drawRoute();
                            }
                            list.style.display = 'none';
                        };
                        list.appendChild(div);
                    });
                }
                list.style.display = 'block';
            });
    }

    // Event listeners for search
    document.getElementById('pickup_input').addEventListener('input', (e) => {
        searchLocation(e.target.value, 'pickup_results', 'pickup_input');
    });

    document.getElementById('dropoff_input').addEventListener('input', (e) => {
        searchLocation(e.target.value, 'dropoff_results', 'dropoff_input');
    });

    // Close dropdown when clicking elsewhere
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-container')) {
            document.getElementById('pickup_results').style.display = 'none';
            document.getElementById('dropoff_results').style.display = 'none';
        }
    });

    function reverseGeocode(lat, lng, inputId) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
            .then(res => res.json())
            .then(data => {
                if (data.display_name) {
                    document.getElementById(inputId).value = data.display_name;
                }
            });
    }

    // --- 5. ROUTING ---
    function drawRoute() {
        const pLat = document.getElementById('pickup_lat').value;
        const pLon = document.getElementById('pickup_lon').value;
        const dLat = document.getElementById('dropoff_lat').value;
        const dLon = document.getElementById('dropoff_lon').value;

        if (!pLat || !dLat) return;

        if (routeLine) map.removeLayer(routeLine);
        
        const url = `https://router.project-osrm.org/route/v1/driving/${pLon},${pLat};${dLon},${dLat}?overview=full&geometries=geojson`;
        
        fetch(url)
            .then(res => res.json())
            .then(data => {
                if (data.routes && data.routes.length > 0) {
                    const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                    routeLine = L.polyline(coords, {
                        color: '#3b82f6',
                        weight: 4,
                        opacity: 0.7,
                        dashArray: '5, 5'
                    }).addTo(map);
                    map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
                }
            });
    }

    // --- 6. PREDICTION FUNCTION ---
    function predictDuration() {
        const pLat = document.getElementById('pickup_lat').value;
        const dLat = document.getElementById('dropoff_lat').value;
        
        if (!pLat || !dLat) {
            alert("Harap pilih lokasi penjemputan dan tujuan terlebih dahulu!");
            return;
        }

        // Show loading
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('result_section').classList.add('hidden');

        const payload = {
            pickup_lat: pLat,
            pickup_lon: document.getElementById('pickup_lon').value,
            dropoff_lat: dLat,
            dropoff_lon: document.getElementById('dropoff_lon').value,
            datetime: document.getElementById('datetime').value,
            passengers: parseInt(document.getElementById('passengers').value)
        };

        fetch('/api/predict_duration', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById('loading').classList.add('hidden');
            
            if (data.status === 'success') {
                // Update results
                document.getElementById('res_duration').innerText = data.duration_minutes;
                document.getElementById('res_distance').innerText = data.distance_km;
                document.getElementById('res_p_cluster').innerText = 'Cluster ' + data.pickup_cluster;
                document.getElementById('res_d_cluster').innerText = 'Cluster ' + data.dropoff_cluster;
                document.getElementById('res_time').innerText = document.getElementById('datetime').value.replace('T', ' ');
                document.getElementById('res_passengers').innerText = payload.passengers;
                document.getElementById('res_p_coords').innerText = `${data.pickup_coords[0].toFixed(4)}, ${data.pickup_coords[1].toFixed(4)}`;
                document.getElementById('res_d_coords').innerText = `${data.dropoff_coords[0].toFixed(4)}, ${data.dropoff_coords[1].toFixed(4)}`;
                
                // Show results
                document.getElementById('result_section').classList.remove('hidden');
                
                // Draw route if not already drawn
                if (!routeLine) {
                    drawRoute();
                }
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(err => {
            document.getElementById('loading').classList.add('hidden');
            alert('Terjadi kesalahan koneksi ke server.');
            console.error(err);
        });
    }

    // --- 7. HELPER FUNCTIONS ---
    function shareResults() {
        const duration = document.getElementById('res_duration').innerText;
        const distance = document.getElementById('res_distance').innerText;
        const text = `Estimasi perjalanan NYC Taxi: ${duration} menit untuk ${distance} km`;
        
        if (navigator.share) {
            navigator.share({
                title: 'NYC Taxi Estimasi',
                text: text,
                url: window.location.href
            });
        } else {
            navigator.clipboard.writeText(text);
            alert('Hasil telah disalin ke clipboard!');
        }
    }

    // Initialize with a sample marker
    setTimeout(() => {
        setPickupMarker(40.7489, -73.9680);
        document.getElementById('pickup_input').value = 'Times Square, New York';
        setDropoffMarker(40.6895, -74.0447);
        document.getElementById('dropoff_input').value = 'Statue of Liberty, New York';
        drawRoute();
    }, 1000);
</script>
{% endblock %}