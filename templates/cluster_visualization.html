{% extends "layout.html" %}

{% block title %}Cluster Visualization - NYC Taxi AI{% endblock %}

{% block extra_css %}
<style>
    #map { 
        height: 600px; 
        width: 100%; 
        border-radius: 12px; 
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    
    .cluster-info-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 5px solid;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid #e5e7eb;
    }
    
    .cluster-info-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .cluster-info-card.selected {
        border: 2px solid #3B82F6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .cluster-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        border: 2px solid white;
        box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        font-size: 12px;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    
    .legend-item:hover {
        background-color: #f3f4f6;
    }
    
    .cluster-stats {
        background: #f8fafc;
        border-radius: 8px;
        padding: 12px;
        margin-top: 10px;
    }
    
    .stat-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        font-size: 12px;
    }
    
    .highlight-circle {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { r: 1500; opacity: 0.2; }
        50% { r: 1600; opacity: 0.1; }
        100% { r: 1500; opacity: 0.2; }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- PAGE HEADER -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
            NYC Taxi Zones Visualization
        </h1>
        <p class="text-gray-600">
            Visualization of 10 NYC taxi zones using clustering
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

        <!-- LEFT PANEL -->
        <div class="lg:col-span-1">
            <div class="glass-card rounded-2xl p-6 shadow-lg border border-gray-100 h-full">

                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-900">
                        <i class="fas fa-layer-group text-blue-600 mr-2"></i>
                        10 Taxi Zones
                    </h2>
                    <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">
                        K-Means
                    </span>
                </div>

                <p class="text-sm text-gray-600 mb-4">
                    Zones are grouped using K-Means clustering based on NYC taxi trip data.
                </p>

                <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 mb-6">
                    <div class="flex items-start text-sm text-blue-700">
                        <i class="fas fa-info-circle mr-2 mt-0.5"></i>
                        <span>Click a zone on the map or list to view details</span>
                    </div>
                </div>

                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-gray-800">All Zones</h3>
                        <span id="clustersCount" class="text-sm text-gray-500">
                            Loading...
                        </span>
                    </div>

                    <div id="clustersList" class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                        <div class="text-center py-4">
                            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                            <p class="text-sm text-gray-500 mt-2">
                                Loading zones...
                            </p>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- RIGHT PANEL -->
        <div class="lg:col-span-3 space-y-6">

            <!-- MAP + DETAIL (ONE CARD, IMPORTANT) -->
            <div class="glass-card rounded-2xl overflow-hidden shadow-lg border border-gray-100">

                <!-- MAP HEADER -->
                <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                    <div>
                        <h3 class="font-semibold text-gray-800">
                            NYC Taxi Clusters Map
                        </h3>
                        <p class="text-xs text-gray-500 mt-1">
                            Each circle represents a zone with a 1.5 km radius
                        </p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="toggleClusters()" id="toggleClustersBtn"
                                class="text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1.5 rounded-lg flex items-center transition-colors">
                            <i class="fas fa-eye mr-2"></i>
                            Hide Zones
                        </button>
                        <button onclick="fitToAllClusters()"
                                class="text-sm bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1.5 rounded-lg flex items-center transition-colors">
                            <i class="fas fa-expand-arrows-alt mr-2"></i>
                            Zoom All
                        </button>
                    </div>
                </div>

                <!-- MAP -->
                <div id="map"></div>

                <!-- CLUSTER DETAILS (APPEARS AFTER CLICK, DIRECTLY UNDER MAP) -->
                <div id="clusterDetails" class="hidden border-t">

                    <div class="p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-900" id="detailTitle">
                                    Zone Details
                                </h3>
                                <div class="flex items-center mt-1">
                                    <div id="detailColor" class="w-4 h-4 rounded-full mr-2"></div>
                                    <span id="detailType" class="text-sm text-gray-600">--</span>
                                </div>
                            </div>
                            <button onclick="closeDetails()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                            <!-- LEFT -->
                            <div>
                                <h4 class="font-semibold text-gray-800 mb-2">Description</h4>
                                <p id="detailDescription" class="text-gray-600 text-sm">--</p>

                                <div class="mt-4">
                                    <h4 class="font-semibold text-gray-800 mb-2">
                                        Center Coordinates
                                    </h4>
                                    <div class="bg-gray-50 p-3 rounded-lg">
                                        <div class="font-mono text-sm" id="detailCoordinates">--</div>
                                    </div>
                                </div>
                            </div>

                            <!-- RIGHT -->
                            <div>
                                <h4 class="font-semibold text-gray-800 mb-2">
                                    Statistics (Simulation)
                                </h4>

                                <div class="cluster-stats">
                                    <div class="stat-item">
                                        <span class="text-gray-600">Average Trips:</span>
                                        <span class="font-semibold" id="avgTrip">--</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="text-gray-600">Average Duration:</span>
                                        <span class="font-semibold" id="avgDuration">--</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="text-gray-600">Average Fare:</span>
                                        <span class="font-semibold" id="avgFare">--</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="text-gray-600">Peak Time:</span>
                                        <span class="font-semibold" id="peakTime">--</span>
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <h4 class="font-semibold text-gray-800 mb-2">
                                        Related Zones
                                    </h4>
                                    <div id="relatedZones" class="flex flex-wrap gap-2"></div>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Initialize map
    const map = L.map('map').setView([40.7580, -73.9855], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '© OpenStreetMap'
    }).addTo(map);

    let clusterLayers = [];
    let selectedCluster = null;
    let clustersVisible = true;

    // Load clusters from API
    async function loadClusters() {
        try {
            const response = await fetch('/api/clusters');
            const data = await response.json();
            
            if (data.status === 'success') {
                clusters = data.clusters; // ✅ SIMPAN DI GLOBAL
                displayClusters(clusters);
                createClusterList(clusters);
                document.getElementById('clustersCount').textContent = `${clusters.length} zones`;
            }
        } catch (error) {
            console.error('Error loading clusters:', error);
            document.getElementById('clustersList').innerHTML = `
                <div class="text-center py-4 text-red-600">
                    <i class="fas fa-exclamation-triangle text-lg mb-2"></i>
                    <p class="text-sm">Failed to load zones</p>
                </div>
            `;
        }
    }


    function displayClusters(clusters) {
        // Clear existing layers
        clusterLayers.forEach(layer => map.removeLayer(layer));
        clusterLayers = [];

        clusters.forEach(cluster => {
            // Create circle for cluster area
            const circle = L.circle(cluster.center, {
                radius: cluster.radius * 1000,
                color: cluster.color,
                fillColor: cluster.color,
                fillOpacity: 0.15,
                weight: 2,
                className: 'cluster-area'
            }).addTo(map);

            // Add click event
            circle.on('click', () => {
                selectCluster(cluster);
            });

            // Create marker for cluster center with number
            const marker = L.marker(cluster.center, {
                icon: L.divIcon({
                    className: 'cluster-center-marker',
                    html: `
                        <div class="flex flex-col items-center">
                            <div class="w-10 h-10 rounded-full border-3 border-white shadow-lg flex items-center justify-center text-white font-bold text-sm"
                                 style="background-color: ${cluster.color}">
                                ${cluster.id}
                            </div>
                            <div class="mt-1 bg-white px-3 py-1 rounded-lg text-xs font-semibold shadow border"
                                 style="color: ${cluster.color}; border-color: ${cluster.color}">
                                ${cluster.name.split(' & ')[0]}
                            </div>
                        </div>
                    `,
                    iconSize: [100, 60]
                })
            }).addTo(map);

            // Add click event to marker
            marker.on('click', () => {
                selectCluster(cluster);
            });

            // Store layers
            clusterLayers.push(circle);
            clusterLayers.push(marker);
        });
    }

    function createClusterList(clusters) {
        const container = document.getElementById('clustersList');
        container.innerHTML = '';

        clusters.forEach(cluster => {
            const card = document.createElement('div');
            card.className = 'cluster-info-card';
            card.style.borderLeftColor = cluster.color;
            card.dataset.clusterId = cluster.id;
            
            card.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center mb-1">
                            <div class="cluster-dot" style="background-color: ${cluster.color}"></div>
                            <div>
                                <h4 class="font-bold text-gray-900">Zona ${cluster.id}</h4>
                                <p class="text-sm text-gray-700">${cluster.name}</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">${cluster.type}</p>
                    </div>
                    <button class="text-gray-400 hover:text-blue-600 ml-2">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            `;

            card.addEventListener('click', () => {
                selectCluster(cluster);
                // Scroll card into view
                card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            });

            container.appendChild(card);
        });
    }

    // function createLegend(clusters) {
    //     const container = document.getElementById('legendContainer');
    //     container.innerHTML = '';

    //     clusters.forEach(cluster => {
    //         const item = document.createElement('div');
    //         item.className = 'legend-item';
    //         item.dataset.clusterId = cluster.id;
            
    //         item.innerHTML = `
    //             <div class="cluster-dot" style="background-color: ${cluster.color}"></div>
    //             <span class="flex-1 text-gray-700">Zona ${cluster.id}</span>
    //             <span class="text-gray-400 text-xs">${cluster.type}</span>
    //         `;

    //         item.addEventListener('click', () => {
    //             selectCluster(cluster);
    //         });

    //         container.appendChild(item);
    //     });
    // }

    function selectCluster(cluster) {
        // Remove previous selection
        if (selectedCluster) {
            const prevCard = document.querySelector(`.cluster-info-card[data-cluster-id="${selectedCluster.id}"]`);
           // const prevLegend = document.querySelector(`.legend-item[data-cluster-id="${selectedCluster.id}"]`);
            
          //  if (prevCard) prevCard.classList.remove('selected');
          //  if (prevLegend) prevLegend.style.backgroundColor = '';
            
            // Reset circle style
            const prevCircle = clusterLayers.find(layer => 
                layer instanceof L.Circle && 
                layer.getLatLng().lat === selectedCluster.center[0] &&
                layer.getLatLng().lng === selectedCluster.center[1]
            );
            
            if (prevCircle) {
                prevCircle.setStyle({
                    fillOpacity: 0.15,
                    weight: 2
                });
            }
        }

        // Highlight selected cluster
        const clusterCircle = clusterLayers.find(layer => 
            layer instanceof L.Circle && 
            layer.getLatLng().lat === cluster.center[0] &&
            layer.getLatLng().lng === cluster.center[1]
        );

        if (clusterCircle) {
            clusterCircle.setStyle({
                fillOpacity: 0.3,
                weight: 3
            });
            selectedCluster = cluster;

            // Center map on cluster with smooth zoom
            map.flyTo(cluster.center, 13, {
                duration: 1
            });

            // Highlight card and legend
            const card = document.querySelector(`.cluster-info-card[data-cluster-id="${cluster.id}"]`);
           //  const legend = document.querySelector(`.legend-item[data-cluster-id="${cluster.id}"]`);
            
            if (card) card.classList.add('selected');
            // if (legend) legend.style.backgroundColor = '#f3f4f6';



            // Show details
            showClusterDetails(cluster);
        }
    }

    function showClusterDetails(cluster) {
        // Generate mock statistics based on cluster ID
        const stats = generateMockStats(cluster.id);
        
        // Update details
        document.getElementById('detailTitle').textContent = `Zona ${cluster.id}: ${cluster.name}`;
        document.getElementById('detailColor').style.backgroundColor = cluster.color;
        document.getElementById('detailType').textContent = cluster.type;
        document.getElementById('detailDescription').textContent =
    getEnglishDescription(cluster);

        document.getElementById('detailCoordinates').textContent = `${cluster.center[0].toFixed(4)}, ${cluster.center[1].toFixed(4)}`;
        
        document.getElementById('avgTrip').textContent = stats.avgTrips;
        document.getElementById('avgDuration').textContent = stats.avgDuration;
        document.getElementById('avgFare').textContent = stats.avgFare;
        document.getElementById('peakTime').textContent = stats.peakTime;
        
        // Generate related zones
        const relatedZones = getRelatedZones(cluster.id);
        const relatedContainer = document.getElementById('relatedZones');
        relatedContainer.innerHTML = '';

        relatedZones.forEach(zoneId => {
            const relatedCluster = clusters.find(c => c.id === zoneId);
            if (!relatedCluster) return;

            const badge = document.createElement('span');
            badge.className =
                'px-3 py-1 rounded-full text-xs font-medium cursor-pointer hover:opacity-80';
            badge.style.backgroundColor = relatedCluster.color + '20';
            badge.style.color = relatedCluster.color;
            badge.textContent = `Zone ${zoneId}`;
            badge.onclick = () => selectCluster(relatedCluster);
            relatedContainer.appendChild(badge);
        });

        
        // Show details panel
        document.getElementById('clusterDetails').classList.remove('hidden');
        
    }

    function generateMockStats(clusterId) {
        // Mock statistics for demonstration
        const stats = {
            avgTrips: Math.floor(Math.random() * 5000) + 1000 + ' per day',
            avgDuration: Math.floor(Math.random() * 25) + 10 + ' min',
            avgFare: '$' + (Math.random() * 30 + 15).toFixed(2),
            peakTime: ['07:00-09:00', '12:00-14:00', '17:00-19:00'][clusterId % 3]
        };
        return stats;
    }

    function getRelatedZones(clusterId) {
        // Mock related zones based on proximity
        const allZones = Array.from({length: 10}, (_, i) => i);
        return allZones.filter(id => id !== clusterId && Math.abs(id - clusterId) <= 2).slice(0, 3);
    }

    function closeDetails() {
        document.getElementById('clusterDetails').classList.add('hidden');
        if (selectedCluster) {
            const card = document.querySelector(`.cluster-info-card[data-cluster-id="${selectedCluster.id}"]`);
            if (card) card.classList.remove('selected');
            
           //  const legend = document.querySelector(`.legend-item[data-cluster-id="${selectedCluster.id}"]`);
           // if (legend) legend.style.backgroundColor = '';
            
            // Reset circle style
            const circle = clusterLayers.find(layer => 
                layer instanceof L.Circle && 
                layer.getLatLng().lat === selectedCluster.center[0] &&
                layer.getLatLng().lng === selectedCluster.center[1]
            );
            
            if (circle) {
                circle.setStyle({
                    fillOpacity: 0.15,
                    weight: 2
                });
            }
            
            selectedCluster = null;

        }
    }
// tambahan deskripsi bahasa inggris
    function getEnglishDescription(cluster) {
    const descriptions = {
        0: "Major business and financial district with high taxi demand.",
        1: "Upscale residential area with museums and access to Roosevelt Island.",
        2: "International airport zone with long-distance travel demand.",
        3: "Lifestyle, technology, and creative business area.",
        4: "Dense residential neighborhood with local mobility.",
        5: "Airport-related mixed commercial and residential area.",
        6: "Trendy area known for nightlife and young population.",
        7: "Tourism and business hotspot with high trip frequency.",
        8: "Residential and academic environment with steady demand.",
        9: "Mixed residential area with balanced trip patterns."
    };

    return descriptions[cluster.id] || "Urban taxi activity zone.";
}


    function fitToAllClusters() {
        if (clusterLayers.length > 0) {
            const bounds = L.latLngBounds();
            clusterLayers.forEach(layer => {
                if (layer.getBounds) {
                    bounds.extend(layer.getBounds());
                } else if (layer.getLatLng) {
                    bounds.extend(layer.getLatLng());
                }
            });
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    }

    function toggleClusters() {
        const btn = document.getElementById('toggleClustersBtn');
        clustersVisible = !clustersVisible;
        
        if (clustersVisible) {
            clusterLayers.forEach(layer => map.addLayer(layer));
            btn.innerHTML = '<i class="fas fa-eye-slash mr-2"></i><span>Sembunyikan Zona</span>';
        } else {
            clusterLayers.forEach(layer => map.removeLayer(layer));
            btn.innerHTML = '<i class="fas fa-eye mr-2"></i><span>Tampilkan Zona</span>';
            
            // Close details if open
            if (selectedCluster) {
                closeDetails();
            }
        }
    }

    // Global clusters variable for related zones function
    let clusters = [];

    // Load clusters on page load
    document.addEventListener('DOMContentLoaded', loadClusters);

</script>
{% endblock %}